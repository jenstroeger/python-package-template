# This workflow checks and tests the package code, and it builds all package
# artifacts whenever there were changes to a pull request.

name: Check change set
on:
  pull_request:
    branches:
    - '*'
    types:
    - opened
    - reopened
    - synchronize
    - ready_for_review
permissions:
  contents: read

jobs:
  build:
    uses: ./.github/workflows/_build.yaml
    permissions:
      contents: read
    with:
      disable-pip-audit: ${{ vars.DISABLE_PIP_AUDIT == 'true' }}

  test:
    needs: [build]
    name: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:

    - name: Check out repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0

    - name: Download artifact
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
      with:
        path: dist
        merge-multiple: true

    # Verify hashes by first computing hashes for the artifacts and then comparing them
    # against the hashes computed by the build job.
    - name: Verify the artifact hash
      env:
        ARTIFACT_HASH: ${{ needs.build.outputs.artifacts-sha256 }}
      run: |
        set -euo pipefail
        echo "Hash of package should be $ARTIFACT_HASH."
        echo "Decoding the artifact hash:"
        ls dist
        echo "$ARTIFACT_HASH" | base64 --decode
        echo "$ARTIFACT_HASH" | base64 --decode | sha256sum --strict --check --status || exit 1

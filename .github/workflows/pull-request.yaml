# This workflow will lint the PR's title and commit message.

name: Pull Request
on:
  pull_request:
    branches: [main, staging]
    types:
    - opened
    - reopened
    - edited
    - synchronize
permissions:
  contents: read

jobs:
  conventional-commits:
    name: Check PR title and commit messages
    runs-on: ubuntu-latest
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@74b568e8591fbb3115c70f3436a0c6b0909a8504
      with:
        egress-policy: audit # TODO: change to 'egress-policy: block' after couple of runs
    - name: Check out repository
      uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b # v3.0.2
      with:
        fetch-depth: 0
    - name: Set up Python
      uses: actions/setup-python@c4e89fac7e8767b327bbad6cb4d859eda999cf08 # v4.1.0
      with:
        python-version: '3.10'
    - name: Create and activate virtual environment
      run: |
        make venv
        source .venv/bin/activate
      env:
        PYTHON: python
    - name: Install dependencies
      run: make setup
    - name: Check PR title
      run: echo "$PR_TITLE" | cz check
      env:
        PR_TITLE: ${{ github.event.pull_request.title }}
    - name: Check PR commit messages
      run: cz check --rev-range origin/$PR_BASE_BRANCH_NAME..origin/$PR_HEAD_BRANCH_NAME
      env:
        PR_BASE_BRANCH_NAME: ${{ github.event.pull_request.base.ref }}
        PR_HEAD_BRANCH_NAME: ${{ github.event.pull_request.head.ref }}

  build:
    needs: conventional-commits
    uses: ./.github/workflows/build.yaml
